'use strict'

const test = require('tap').test
const fs = require('fs')
const path = require('path')
const findVisualStudio = require('../lib/find-visualstudio')
const VisualStudioFinder = findVisualStudio.test.VisualStudioFinder

const semverV1 = { major: 1, minor: 0, patch: 0 }

delete process.env.VCINSTALLDIR

function poison (object, property) {
  function fail () {
    console.error(Error(`Property ${property} should not have been accessed.`))
    process.abort()
  }
  var descriptor = {
    configurable: false,
    enumerable: false,
    get: fail,
    set: fail
  }
  Object.defineProperty(object, property, descriptor)
}

function TestVisualStudioFinder () { VisualStudioFinder.apply(this, arguments) }
TestVisualStudioFinder.prototype = Object.create(VisualStudioFinder.prototype)
// Silence npmlog - remove for debugging
TestVisualStudioFinder.prototype.log = {
  silly: () => {},
  verbose: () => {},
  info: () => {},
  warn: () => {},
  error: () => {}
}

test('VS2013', function (t) {
  t.plan(4)

  const finder = new TestVisualStudioFinder(semverV1, null, (err, info) => {
    t.strictEqual(err, null)
    t.deepEqual(info, {
      msBuild: 'C:\\MSBuild12\\MSBuild.exe',
      path: 'C:\\VS2013',
      sdk: null,
      toolset: 'v120',
      version: '12.0',
      versionMajor: 12,
      versionMinor: 0,
      versionYear: 2013
    })
  })

  finder.findVisualStudio2017OrNewer = (cb) => {
    finder.parseData(new Error(), '', '', cb)
  }
  finder.regSearchKeys = (keys, value, addOpts, cb) => {
    for (var i = 0; i < keys.length; ++i) {
      const fullName = `${keys[i]}\\${value}`
      switch (fullName) {
        case 'HKLM\\Software\\Microsoft\\VisualStudio\\SxS\\VC7\\14.0':
        case 'HKLM\\Software\\Wow6432Node\\Microsoft\\VisualStudio\\SxS\\VC7\\14.0':
          continue
        case 'HKLM\\Software\\Microsoft\\VisualStudio\\SxS\\VC7\\12.0':
          t.pass(`expected search for registry value ${fullName}`)
          return cb(null, 'C:\\VS2013\\VC\\')
        case 'HKLM\\Software\\Microsoft\\MSBuild\\ToolsVersions\\12.0\\MSBuildToolsPath':
          t.pass(`expected search for registry value ${fullName}`)
          return cb(null, 'C:\\MSBuild12\\')
        default:
          t.fail(`unexpected search for registry value ${fullName}`)
      }
    }
    return cb(new Error())
  }
  finder.findVisualStudio()
})

test('VS2013 should not be found on new node versions', function (t) {
  t.plan(2)

  const finder = new TestVisualStudioFinder({
    major: 10,
    minor: 0,
    patch: 0
  }, null, (err, info) => {
    t.ok(/find .* Visual Studio/i.test(err), 'expect error')
    t.false(info, 'no data')
  })

  finder.findVisualStudio2017OrNewer = (cb) => {
    const file = path.join(__dirname, 'fixtures', 'VS_2017_Unusable.txt')
    const data = fs.readFileSync(file)
    finder.parseData(null, data, '', cb)
  }
  finder.regSearchKeys = (keys, value, addOpts, cb) => {
    for (var i = 0; i < keys.length; ++i) {
      const fullName = `${keys[i]}\\${value}`
      switch (fullName) {
        case 'HKLM\\Software\\Microsoft\\VisualStudio\\SxS\\VC7\\14.0':
        case 'HKLM\\Software\\Wow6432Node\\Microsoft\\VisualStudio\\SxS\\VC7\\14.0':
          continue
        default:
          t.fail(`unexpected search for registry value ${fullName}`)
      }
    }
    return cb(new Error())
  }
  finder.findVisualStudio()
})

test('VS2015', function (t) {
  t.plan(4)

  const finder = new TestVisualStudioFinder(semverV1, null, (err, info) => {
    t.strictEqual(err, null)
    t.deepEqual(info, {
      msBuild: 'C:\\MSBuild14\\MSBuild.exe',
      path: 'C:\\VS2015',
      sdk: null,
      toolset: 'v140',
      version: '14.0',
      versionMajor: 14,
      versionMinor: 0,
      versionYear: 2015
    })
  })

  finder.findVisualStudio2017OrNewer = (cb) => {
    finder.parseData(new Error(), '', '', cb)
  }
  finder.regSearchKeys = (keys, value, addOpts, cb) => {
    for (var i = 0; i < keys.length; ++i) {
      const fullName = `${keys[i]}\\${value}`
      switch (fullName) {
        case 'HKLM\\Software\\Microsoft\\VisualStudio\\SxS\\VC7\\14.0':
          t.pass(`expected search for registry value ${fullName}`)
          return cb(null, 'C:\\VS2015\\VC\\')
        case 'HKLM\\Software\\Microsoft\\MSBuild\\ToolsVersions\\14.0\\MSBuildToolsPath':
          t.pass(`expected search for registry value ${fullName}`)
          return cb(null, 'C:\\MSBuild14\\')
        default:
          t.fail(`unexpected search for registry value ${fullName}`)
      }
    }
    return cb(new Error())
  }
  finder.findVisualStudio()
})

test('error from PowerShell', function (t) {
  t.plan(2)

  const finder = new TestVisualStudioFinder(semverV1, null, null)

  finder.parseData(new Error(), '', '', (info) => {
    t.ok(/use PowerShell/i.test(finder.errorLog[0]), 'expect error')
    t.false(info, 'no data')
  })
})

test('empty output from PowerShell', function (t) {
  t.plan(2)

  const finder = new TestVisualStudioFinder(semverV1, null, null)

  finder.parseData(null, '', '', (info) => {
    t.ok(/use PowerShell/i.test(finder.errorLog[0]), 'expect error')
    t.false(info, 'no data')
  })
})

test('output from PowerShell not JSON', function (t) {
  t.plan(2)

  const finder = new TestVisualStudioFinder(semverV1, null, null)

  finder.parseData(null, 'AAAABBBB', '', (info) => {
    t.ok(/use PowerShell/i.test(finder.errorLog[0]), 'expect error')
    t.false(info, 'no data')
  })
})

test('wrong JSON from PowerShell', function (t) {
  t.plan(2)

  const finder = new TestVisualStudioFinder(semverV1, null, null)

  finder.parseData(null, '{}', '', (info) => {
    t.ok(/use PowerShell/i.test(finder.errorLog[0]), 'expect error')
    t.false(info, 'no data')
  })
})

test('empty JSON from PowerShell', function (t) {
  t.plan(2)

  const finder = new TestVisualStudioFinder(semverV1, null, null)

  finder.parseData(null, '[]', '', (info) => {
    t.ok(/find .* Visual Studio/i.test(finder.errorLog[0]), 'expect error')
    t.false(info, 'no data')
  })
})

test('future version', function (t) {
  t.plan(3)

  const finder = new TestVisualStudioFinder(semverV1, null, null)

  finder.parseData(null, JSON.stringify([{
    packages: [
      'Microsoft.VisualStudio.Component.VC.Tools.x86.x64',
      'Microsoft.VisualStudio.Component.Windows10SDK.17763',
      'Microsoft.VisualStudio.VC.MSBuild.Base'
    ],
    path: 'C:\\VS',
    version: '9999.9999.9999.9999'
  }]), '', (info) => {
    t.ok(/unknown version/i.test(finder.errorLog[0]), 'expect error')
    t.ok(/find .* Visual Studio/i.test(finder.errorLog[1]), 'expect error')
    t.false(info, 'no data')
  })
})

test('single unusable VS2017', function (t) {
  t.plan(3)

  const finder = new TestVisualStudioFinder(semverV1, null, null)

  const file = path.join(__dirname, 'fixtures', 'VS_2017_Unusable.txt')
  const data = fs.readFileSync(file)
  finder.parseData(null, data, '', (info) => {
    t.ok(/checking/i.test(finder.errorLog[0]), 'expect error')
    t.ok(/find .* Visual Studio/i.test(finder.errorLog[2]), 'expect error')
    t.false(info, 'no data')
  })
})

test('minimal VS2017 Build Tools', function (t) {
  t.plan(2)

  const finder = new TestVisualStudioFinder(semverV1, null, (err, info) => {
    t.strictEqual(err, null)
    t.deepEqual(info, {
      msBuild: 'C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\' +
        'BuildTools\\MSBuild\\15.0\\Bin\\MSBuild.exe',
      path:
        'C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\BuildTools',
      sdk: '10.0.17134.0',
      toolset: 'v141',
      version: '15.9.28307.665',
      versionMajor: 15,
      versionMinor: 9,
      versionYear: 2017
    })
  }